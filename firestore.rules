rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES DE VALIDAÇÃO HÍBRIDAS (Token ou Base de Dados) ---
    
    function signedIn() { 
      return request.auth != null; 
    }
    
    // Verifica se o utilizador está ativo (no Token ou na BD se o token estiver vazio)
    function isActive() { 
      return signedIn() && (
        request.auth.token.ativo == true || 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ativo == true
      ); 
    }

    // Perfil ADMIN: Verifica role no Token ou na BD
    function isAdmin() { 
      return isActive() && (
        request.auth.token.role == "ADMIN" || 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "ADMIN"
      ); 
    }

    // Perfil GESTOR: Verifica role no Token ou na BD
    function isGestor() { 
      return isActive() && (
        request.auth.token.role == "ADMIN" || request.auth.token.role == "GESTOR" ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "ADMIN" ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "GESTOR"
      ); 
    }

    // --- REGRAS POR COLECÇÃO ---

    // Utilizadores: Alterado para permitir que membros ATIVOS leiam a coleção.
    // Necessário para que a query de notificações (procurar emails de ADMIN/GESTOR) funcione
    match /users/{uid} {
      allow read: if isActive(); 
      allow write: if isAdmin();
    }

    // Configurações de Email: Acesso EXCLUSIVO ao ADMIN
    match /config/email {
      allow read, write: if isAdmin();
    }

    // Inventário: Ativos lêem; Gestores/Admins escrevem
    match /equipamentos/{id} {
      allow read: if isActive();
      allow write: if isGestor();
    }

    // Requisições
    match /requisicoes/{rid} {
      allow create: if isActive();
      allow read: if isGestor() || (isActive() && resource.data.criadaPorUid == request.auth.uid);
      allow update: if isGestor();
      
      match /itens/{iid} {
        allow read, write: if isGestor() || (isActive() && get(/databases/$(database)/documents/requisicoes/$(rid)).data.criadaPorUid == request.auth.uid);
      }
    }
    
    // Taxonomias (Tipos e Utilizações)
    match /utilizacoes/{id} { allow read: if isActive(); allow write: if isGestor(); }
    match /tipos/{id} { allow read: if isActive(); allow write: if isGestor(); }

    // Logs e Eventos
    match /eventosEquipamento/{id} {
      allow read, write: if isGestor();
    }
    
    // Coleção para Trigger de Emails (se usares a extensão)
    match /mail/{id} {
      allow create: if isActive();
    }
  }
}