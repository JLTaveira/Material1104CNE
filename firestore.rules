rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isActive() {
      return signedIn() && userDoc().ativo == true;
    }

    // Perfil SUPER: Gere tudo
    function isAdmin() {
      return isActive() && userDoc().role == "ADMIN";
    }

    // Perfil GESTÃO: Gere material e requisições (ADMIN também pode)
    function isGestor() {
      return isActive() && (userDoc().role == "ADMIN" || userDoc().role == "GESTOR");
    }

    // Utilizadores: Gerido APENAS pelo ADMIN
    match /users/{uid} {
      allow read: if isGestor() || (signedIn() && request.auth.uid == uid);
      allow write: if isAdmin();
    }

    // Inventário: USER lê; GESTOR escreve
    match /equipamentos/{id} {
      allow read: if isActive();
      allow write: if isGestor();
    }

    // Requisições: USER cria/vê as suas; GESTOR gere todas
    match /requisicoes/{rid} {
      allow create: if isActive();
      allow read: if isGestor() || (isActive() && resource.data.criadaPorUid == request.auth.uid);
      allow update: if isGestor();
      
      match /itens/{iid} {
        allow read, write: if isGestor() || (isActive() && get(/databases/$(database)/documents/requisicoes/$(rid)).data.criadaPorUid == request.auth.uid);
      }
    }
    
    // Outras coleções (tipos, utilizacoes, etc)
    match /{path=**}/tipos/{id} { allow read: if isActive(); allow write: if isGestor(); }
    match /{path=**}/utilizacoes/{id} { allow read: if isActive(); allow write: if isGestor(); }
  }
}